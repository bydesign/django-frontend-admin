<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <link href="js/codemirror/lib/codemirror.css" rel="stylesheet" />
  <link href="js/codemirror/theme/duotone-light.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,500" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
  <link href="css/default.css" rel="stylesheet">
  <title>Django Frontend Admin</title>
</head>
<body>

<p>Nothing to see here</p>

<template id="childTemplate">

{% extends "baseTemplate" %}

{% block 'header' %}
<nav>
  <a href="#">Nav item</a>
  <a href="#">Nav item</a>
  <a href="#">Nav item</a>
  <a href="#">Nav item</a>
</nav>
{% block extraHeader %}<p>extra header block</p>{% endblock %}
{% endblock %}

{% block 'footer' %}
<div>Copyright information and other random <b>{{ footerCode }}</b>.</div>
{% endblock %}

{{ finalvariable }} final text</template>

<template id="includeTemplate">

<p>This paragraph has {{ not }} been included via the include template tag.</p>

</template>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="js/codemirror/codemirror.min.js"></script>
<script src="js/codemirror/addon/mode/overlay.js"></script>
<script src="js/codemirror/mode/django/django.js"></script>
<script>
var TEMPLATES = [
  {
    name: 'baseTemplate',
    content: "<!doctype html><html><head><title>Replaced Django Frontend Admin</title></head><body><div id='doc'><h1>Title goes here.</h1>{% block 'header' %}{% endblock %}<p></p>{% block 'footer' %}{% endblock %}</div></body></html>"
  },
  {
    name: 'childTemplate',
    content: $(childTemplate).html(),
    start: true
  },
  {
    name: 'includeTemplate',
    content: $(includeTemplate).html()
  },
]
</script>
<script src="js/builtin_tags.js"></script>
<script src="js/parser.js"></script>
<script src="js/processor.js"></script>
<script src="js/default.js"></script>
<script>
$('body').append('<div id="frontEditor" class="FEbtn">FE</div>');

var context = {
  not: 'definitely (resolved)',
  footerCode: 'footer code value (resolved)',
  finalvariable: 'my last words (resolved)'
};

function render() {
  rendering = true;
  FA.process(TEMPLATES);
  FA.render(context);
  rendering = false;
}

var rendering = false;
$('#frontEditor').click(function() {
  $(this).hide();
  window.FA = new FrontAdmin();
  FA.registerTags(BUILTIN_TAGS);
  render();

  $('body').append('<div class="FE" id="FE"><div class="FEtitle">FrontEditor <span class="FEutils"><i class="material-icons">save</i><select id="templates" class="FEtemplateSelect"><option>Select template</option></select><i class="material-icons" id="closeFA">highlight_off</i></span></div><textarea id="myTextarea"></textarea></div>');
  $('#closeFA').click(function() {
    $('#FE').remove();
    $('#frontEditor').show();
  })
  var editor = CodeMirror.fromTextArea(myTextarea, {
    lineNumbers: true,
    theme: 'duotone-light',
    mode: 'django'
  });
  var curTemplate = FA.template;
  editor.setValue(curTemplate.content);
  editor.on('changes', function(cm, change) {
    if (rendering) {
      console.log('waiting for render ...');
    } else {
      curTemplate.content = editor.getValue();
      render();
    }
  });

  var activeClass = 'FAactive';
  editor.on('cursorActivity', function(cm) {
    var nodeId = FA.getNodeId(cm.getCursor());
    activateNode($('[fa-tag-id='+nodeId+']'));
  });

  $(document).click(function(event) {
    var $target = $(event.target);
    var tagIdStr = $target.attr('fa-tag-id');
    if (tagIdStr != undefined) {
      var tag = FA.getTag( Number(tagIdStr) );
      editor.setSelection(tag.start, tag.end);
      activateNode($target);
    }
  })

  function activateNode(node) {
    $('.'+activeClass).removeClass(activeClass);
    $(node).addClass(activeClass);
  }
});


</script>

</body>
</html>
